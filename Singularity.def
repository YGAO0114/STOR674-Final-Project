Bootstrap: docker
From: nvidia/cuda:12.1.0-cudnn8-runtime-ubuntu22.04

%environment
    export DEBIAN_FRONTEND=noninteractive
    export PYTHONUNBUFFERED=1
    export PIP_NO_CACHE_DIR=1
    export PIP_DISABLE_PIP_VERSION_CHECK=1
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

%files
    requirements.txt /tmp/requirements.txt

%post
    # Update package list
    apt-get update
    
    # Install system dependencies
    apt-get install -y \
        python3.10 \
        python3-pip \
        python3.10-dev \
        git \
        wget \
        curl \
        build-essential \
        libgl1-mesa-glx \
        libglib2.0-0 \
        libsm6 \
        libxext6 \
        libxrender-dev \
        libgomp1 \
        && rm -rf /var/lib/apt/lists/*
    
    # Create symlink for python
    ln -s /usr/bin/python3.10 /usr/bin/python
    
    # Upgrade pip
    pip3 install --upgrade pip setuptools wheel
    
    # Install Python dependencies from requirements.txt
    # Check if file exists, if not, list packages directly
    if [ -f /tmp/requirements.txt ]; then
        pip3 install --no-cache-dir -r /tmp/requirements.txt
        rm /tmp/requirements.txt
    else
        # Fallback: install packages directly
        pip3 install --no-cache-dir \
            nnunetv2==2.6.2 \
            batchgenerators==0.25.1 \
            batchgeneratorsv2==0.3.0 \
            dynamic_network_architectures==0.4.2 \
            nibabel==5.3.2 \
            SimpleITK==2.5.2 \
            scikit-image==0.24.0 \
            imageio==2.33.1 \
            tifffile==2023.4.12 \
            Pillow==10.4.0 \
            torch==2.9.0 \
            torchvision==0.24.0 \
            timm==1.0.20 \
            numpy==1.26.4 \
            scipy==1.13.1 \
            pandas==2.2.2 \
            matplotlib==3.9.2 \
            seaborn==0.13.2 \
            h5py==3.11.0 \
            tqdm==4.66.5 \
            einops==0.8.1 \
            connected-components-3d==3.26.0 \
            napari==0.6.2 \
            vispy==0.15.2 \
            pyyaml==6.0.1 \
            pathlib2==2.3.7
    fi

%runscript
    exec "$@"

%labels
    Author STOR674
    Version 1.0
    Description nnUNet medical image segmentation environment

